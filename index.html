<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>実車評価支援ツール</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0ea5e9">
<link rel="stylesheet" href="leaflet.css">
<style>
  html,body,#map{height:100%;margin:0}
  #panel{
    position:absolute;top:10px;left:10px;z-index:1000;background:#fff;
    padding:10px 12px;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.2);
    font-family:system-ui, sans-serif;min-width:280px;max-width:min(92vw,460px)
  }
  #panel h1{font-size:14px;margin:0 0 6px;font-weight:700}
  #panel .row{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin:6px 0}
  #panel label{font-size:12px}
  .badge{display:inline-block;background:#eef;border:1px solid #ccd;border-radius:6px;padding:1px 6px;font-size:11px}
  .small{font-size:11px;color:#555}
  button{cursor:pointer}
  .btn{background:#0ea5e9;color:#fff;border:none;border-radius:8px;padding:6px 10px}
  .btn.gray{background:#64748b}
  .toggle{display:inline-flex;align-items:center;gap:6px}
  .grow{flex:1}
</style>
</head>
<body>
<div id="map"></div>

<div id="panel">
  <h1>実車評価支援ツール</h1>

  <div class="row">
    <input class="grow" type="file" id="file" accept=".kml,.kmz">
    <button id="clear" class="btn gray">クリア</button>
  </div>

  <div class="row">
    <button id="track" class="btn">位置追跡 ▶</button>
    <button id="stop" class="btn gray">■ 停止</button>
    <button id="recenter" class="btn">現在地へ</button>
    <label class="toggle"><input type="checkbox" id="follow" checked> 自動追従</label>
  </div>

  <div class="row">
    <label>通知距離: <span id="thv" class="badge">100m</span></label>
    <input id="th" class="grow" type="range" min="20" max="300" value="100">
  </div>

  <div class="row">
    <button id="tts" class="btn gray">音声テスト</button>
    <button id="save-gpx" class="btn gray">GPX保存</button>
    <span class="small" id="stat"></span>
  </div>

  <div class="small">※ オンライン時に表示した地図は自動で端末にキャッシュされ、圏外でも表示されます。</div>
</div>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js');
  }
</script>

<script src="leaflet.js"></script>
<script src="jszip.min.js"></script>
<script src="togeojson.umd.js"></script>
<script>
const map = L.map('map', { zoomControl: true }).setView([35.0, 135.0], 14);
const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, crossOrigin: true, attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let threshold = 100;
let points = [];
let watchId = null;
let meLayer = null;
let routeLayer = null, pointLayer = null;
let follow = true;
let lastHere = null;

// 走行ログ
let logging = false;
let trackCoords = [];
let trackLayer = null;

const $ = (id)=>document.getElementById(id);
const elTh = $('th'), elThV = $('thv'), elStat = $('stat'), elFollow = $('follow');

elTh.addEventListener('input', ()=>{ threshold = +elTh.value; elThV.textContent = threshold + 'm'; });
elFollow.addEventListener('change', ()=>{ follow = elFollow.checked; if (follow && lastHere) centerWithPanelOffset(lastHere); });

$('tts').addEventListener('click', ()=> speak('音声テストです'));

$('clear').addEventListener('click', ()=>{
  if(routeLayer) map.removeLayer(routeLayer);
  if(pointLayer) map.removeLayer(pointLayer);
  if(trackLayer) { map.removeLayer(trackLayer); trackLayer = null; }
  points = [];
  trackCoords = [];
});

$('track').addEventListener('click', ()=>{
  if (watchId) navigator.geolocation.clearWatch(watchId);
  watchId = navigator.geolocation.watchPosition(onPos, onErr, {enableHighAccuracy:true, maximumAge:1000, timeout:10000});
  logging = true;
  $('track').textContent = '録画中…';
});

$('stop').addEventListener('click', ()=>{
  if (watchId){ navigator.geolocation.clearWatch(watchId); watchId = null; }
  logging = false;
  $('track').textContent = '位置追跡 ▶';
  elStat.textContent = '';
});

$('recenter').addEventListener('click', ()=>{
  if(!lastHere) return;
  follow = true; elFollow.checked = true;
  centerWithPanelOffset(lastHere);
});

$('file').addEventListener('change', onFile);
$('save-gpx').addEventListener('click', saveGPX);

map.on('dragstart zoomstart', ()=>{ follow = false; elFollow.checked = false; });

function centerWithPanelOffset(latlng){
  const panel = $('panel');
  const off = L.point(
    Math.round((panel.offsetWidth/2) + 16),
    Math.round((panel.offsetHeight/2) + 16)
  );
  const pt = map.latLngToContainerPoint(latlng).subtract(off);
  const dst = map.containerPointToLatLng(pt);
  map.setView(dst, map.getZoom(), {animate:false});
}

function onPos(pos){
  const {latitude, longitude, accuracy, speed} = pos.coords;
  const here = L.latLng(latitude, longitude);
  lastHere = here;

  if(!meLayer){
    meLayer = L.circleMarker(here, {radius:8, color:'#dc2626', weight:3, fillColor:'#fecaca', fillOpacity:1})
      .addTo(map);
  }else{
    meLayer.setLatLng(here);
  }

  if (follow) centerWithPanelOffset(here);

  elStat.textContent = `精度 ${Math.round(accuracy||0)}m / 速度 ${speed!=null?Math.round(speed*3.6):'-'}km/h`;

  // 走行ログ（精度30m以内＆5m以上移動時）
  if (logging) {
    const last = trackCoords.length ? L.latLng(trackCoords[trackCoords.length-1][0], trackCoords[trackCoords.length-1][1]) : null;
    const moved = last ? here.distanceTo(last) : Infinity;
    if ((accuracy ?? 99) <= 30 && moved >= 5) {
      trackCoords.push([here.lat, here.lng, new Date().toISOString()]);
      if (!trackLayer) {
        trackLayer = L.polyline(trackCoords.map(p=>[p[0],p[1]]), {color:'#f59e0b', weight:4}).addTo(map);
      } else {
        trackLayer.setLatLngs(trackCoords.map(p=>[p[0],p[1]]));
      }
    }
  }

  for(const p of points){
    if(p.announced) continue;
    if(haversine(here, p.latlng) <= threshold){
      p.announced = true;
      speak(p.name + '。 ' + p.desc);
    }
  }
}
function onErr(err){ alert('位置取得に失敗: ' + err.message); }

async function onFile(ev){
  const f = ev.target.files[0];
  if(!f) return;
  const isKMZ = /\.kmz$/i.test(f.name);
  let kmlText = null;

  if(isKMZ){
    const buf = await f.arrayBuffer();
    const zip = await JSZip.loadAsync(buf);
    let kmlEntry = null;
    zip.forEach((p, entry)=>{ if(!kmlEntry && p.toLowerCase().endsWith('.kml')) kmlEntry = entry; });
    if(!kmlEntry) return alert('KMZ内にKMLがありません');
    kmlText = await kmlEntry.async('string');
  } else {
    kmlText = await f.text();
  }

  const kmlDom = new DOMParser().parseFromString(kmlText, 'text/xml');
  const gj = toGeoJSON.kml(kmlDom);

  if(routeLayer) map.removeLayer(routeLayer);
  if(pointLayer) map.removeLayer(pointLayer);
  points = [];

  const lineFeats = gj.features.filter(ft => ft.geometry && ft.geometry.type.includes('Line'));
  const lines = lineFeats.map(ft => L.polyline(ft.geometry.coordinates.map(c=>[c[1], c[0]]), {color:'#2b8a3e', weight:4}));
  routeLayer = L.layerGroup(lines).addTo(map);

  const ptFeats = gj.features.filter(ft => ft.geometry && ft.geometry.type === 'Point');
  pointLayer = L.geoJSON({type:'FeatureCollection', features: ptFeats}, {
    pointToLayer: (ft, latlng)=> L.circleMarker(latlng, {radius:7, color:'#1e3a8a', weight:2, fillColor:'#60a5fa', fillOpacity:.85}),
    onEachFeature: (ft, layer)=>{
      const name = ft.properties.name || 'チェックポイント';
      const desc = ft.properties.description || '';
      layer.bindPopup(`<b>${name}</b><br>${desc}`);
      points.push({latlng: layer.getLatLng(), name, desc, announced:false});
    }
  }).addTo(map);

  const g = L.featureGroup([routeLayer, pointLayer]);
  const panel = $('panel');
  map.fitBounds(g.getBounds(), {
    paddingTopLeft: [panel.offsetWidth + 24, panel.offsetHeight + 24],
    paddingBottomRight: [24, 24]
  });
}

function speak(text){
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'ja-JP';
  speechSynthesis.speak(u);
}
function haversine(a,b){
  const R = 6371000; const toRad = d=> d*Math.PI/180;
  const dlat = toRad(b.lat-a.lat), dlon = toRad(b.lng-a.lng);
  const s = Math.sin(dlat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dlon/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));
}

function saveGPX(){
  if (!trackCoords.length) { alert('走行ログがありません'); return; }
  const seg = trackCoords.map(([lat, lng, t]) =>
    `      <trkpt lat="${lat}" lon="${lng}"><time>${t||new Date().toISOString()}</time></trkpt>`).join('\n');

  const gpx =
`<?xml version="1.0" encoding="UTF-8"?>
<gpx creator="route-aid" version="1.1" xmlns="http://www.topografix.com/GPX/1/1">
  <trk>
    <name>Drive Log</name>
    <trkseg>
${seg}
    </trkseg>
  </trk>
</gpx>`;

  const blob = new Blob([gpx], {type:'application/gpx+xml'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `drive-log-${new Date().toISOString().replace(/[:.]/g,'-')}.gpx`;
  a.click();
  URL.revokeObjectURL(a.href);
}
</script>
</body>
</html>
